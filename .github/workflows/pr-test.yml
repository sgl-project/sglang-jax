name: PR Test

on:
  push:
    branches:
      - main
      - 'epic/*'
    paths:
      - "python/**"
      - "scripts/**"
      - "test/**"
      - ".github/workflows/pr-test.yml"
  pull_request:
    branches:
      - main
      - 'epic/*'
    paths:
      - "python/**"
      - "scripts/**"
      - "test/**"
      - ".github/workflows/pr-test.yml"

concurrency:
  group: pr-test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-test-1-tpu:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Check if GCP_SA_KEY secret is injected
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "❌ GCP_SA_KEY is NOT set"
            exit 1
          else
            echo "✅ GCP_SA_KEY is set (value length: ${#GCP_SA_KEY})"
          fi
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      - name: Setup gcloud
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials tpu-service --zone=us-east5 --project=tpu-service-473302

      - name: Submit TPU v6e-1 Job
        env:
          COMMIT_SHA: ${{ github.sha }}
        run: |
          JOB_NAME="tpu-test-v6e-1-${GITHUB_RUN_ID}"
          cat > job.yaml <<EOF
          apiVersion: batch/v1
          kind: Job
          meta
            name: \$JOB_NAME
          spec:
            ttlSecondsAfterFinished: 1800
            backoffLimit: 1
            template:
              spec:
                containers:
                - name: sky-launcher
                  image: python:3.12-slim
                  command: ["/bin/bash", "-c"]
                  args:
                    - |
                      set -e
                      apt update && apt install -y git curl openssh-client
                      pip install skypilot-nightly
                      mkdir -p ~/.ssh
                      cp /secret/id_rsa ~/.ssh/id_rsa
                      chmod 600 ~/.ssh/id_rsa
                      cp /config/sky-task.yaml ./task.yaml
                      sed -i "s|TPU_VARIANT_PLACEHOLDER|tpu-v6e-1|g" ./task.yaml
                      sed -i "s|COMMIT_SHA_PLACEHOLDER|${COMMIT_SHA}|g" ./task.yaml
                      sky launch ./task.yaml -y \
                        --use-spot \
                        --idle-minutes-to-autostop 120 \
                        --down \
                        -- "uv venv --python 3.12 && source .venv/bin/activate && cd sglang-jax && uv pip install -e "python[all]" && bash scripts/killall_sglang.sh && uv run python test/srt/run_suite.py --suite per-commit-tpu-v6e-1"
                  volumeMounts:
                    - name: config-volume
                      mountPath: /config
                    - name: ssh-secret
                      mountPath: /secret
                volumes:
                  - name: config-volume
                    configMap:
                      name: sky-task-base
                  - name: ssh-secret
                    secret:
                      secretName: ssh-key-secret
                restartPolicy: Never
          EOF
          kubectl apply -f job.yaml
          echo "job_name=$JOB_NAME" >> $GITHUB_ENV

      - name: Wait and collect logs
        run: |
          timeout 7200 kubectl wait --for=condition=complete job/${{ env.job_name }} --timeout=7200s
          kubectl logs job/${{ env.job_name }}
          if kubectl get job ${{ env.job_name }} -o jsonpath='{.status.failed}' | grep -q '[1-9]'; then
            exit 1
          fi

  e2e-test-4-tpu:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Setup gcloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials tpu-service --zone=us-east5 --project=tpu-service-473302

      - name: Submit TPU v6e-4 Job
        env:
          COMMIT_SHA: ${{ github.sha }}
        run: |
          JOB_NAME="tpu-test-v6e-4-${GITHUB_RUN_ID}"
          cat > job.yaml <<EOF
          apiVersion: batch/v1
          kind: Job
          meta
            name: \$JOB_NAME
          spec:
            ttlSecondsAfterFinished: 1800
            backoffLimit: 1
            template:
              spec:
                containers:
                - name: sky-launcher
                  image: python:3.12-slim
                  command: ["/bin/bash", "-c"]
                  args:
                    - |
                      set -e
                      apt update && apt install -y git curl openssh-client
                      pip install skypilot-nightly
                      mkdir -p ~/.ssh
                      cp /secret/id_rsa ~/.ssh/id_rsa
                      chmod 600 ~/.ssh/id_rsa
                      cp /config/sky-task.yaml ./task.yaml
                      sed -i "s|TPU_VARIANT_PLACEHOLDER|tpu-v6e-4|g" ./task.yaml
                      sed -i "s|COMMIT_SHA_PLACEHOLDER|${COMMIT_SHA}|g" ./task.yaml
                      sky launch ./task.yaml -y \
                        --use-spot \
                        --idle-minutes-to-autostop 120 \
                        --down \
                        -- "uv venv --python 3.12 && source .venv/bin/activate && cd sglang-jax && uv pip install -e "python[all]" && bash scripts/killall_sglang.sh && uv run python test/srt/run_suite.py --suite per-commit-tpu-v6e-4"
                  volumeMounts:
                    - name: config-volume
                      mountPath: /config
                    - name: ssh-secret
                      mountPath: /secret
                volumes:
                  - name: config-volume
                    configMap:
                      name: sky-task-base
                  - name: ssh-secret
                    secret:
                      secretName: ssh-key-secret
                restartPolicy: Never
          EOF
          kubectl apply -f job.yaml
          echo "job_name=$JOB_NAME" >> $GITHUB_ENV

      - name: Wait and collect logs
        run: |
          timeout 7200 kubectl wait --for=condition=complete job/${{ env.job_name }} --timeout=7200s
          kubectl logs job/${{ env.job_name }}
          if kubectl get job ${{ env.job_name }} -o jsonpath='{.status.failed}' | grep -q '[1-9]'; then
            exit 1
          fi

  pr-test-finish:
    needs: [e2e-test-1-tpu, e2e-test-4-tpu]
    runs-on: ubuntu-latest
    steps:
      - name: All tests passed
        run: echo "✅ All TPU tests completed successfully"

  # performance-test-1-tpu:
  #   if: github.event.pull_request.draft == false
  #   runs-on: self-hosted
  #   strategy:
  #     fail-fast: false
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     - name: Setup environment
  #       uses: ./.github/actions/setup_environment
  #       with:
  #         accelerator: tpu-v6e-1
  #         test_type: performance
  #         skypilot_endpoint: ${{ secrets.SKYPILOT_ENDPOINT }}
  #         username: ${{ secrets.USERNAME }}
  #         git_token: ${{ secrets.GIT_TOKEN }}
  #     - name: Benchmark single latency
  #       timeout-minutes: 30
  #       run: |
  #         source ~/sky/bin/activate
  #         CLUSTER_NAME=$(bash scripts/get_cluster_name.sh tpu-v6e-1 ${{ github.ref }} performance)
  #         sky exec "$CLUSTER_NAME" -- 'set -e; cd sglang-jax/test/srt; uv run python -m unittest test_bench_one_batch.TestBenchOneBatch.test_bs1_default'

      # - name: Benchmark online latency
      #   timeout-minutes: 10
      #   run: |
      #     source ~/sky/bin/activate
      #     CLUSTER_NAME=$(bash scripts/get_cluster_name.sh tpu-v6e-1 ${{ github.ref }} performance)
      #     sky exec "$CLUSTER_NAME" -- 'set -e; cd sglang-jax/test/srt; python3 -m unittest test_bench_serving.TestBenchServing.test_online_latency_default'

      # - name: Benchmark offline throughput (w/o RadixAttention)
      #   timeout-minutes: 10
      #   run: |
      #     source ~/sky/bin/activate
      #     CLUSTER_NAME=$(bash scripts/get_cluster_name.sh tpu-v6e-1 ${{ github.ref }} performance)
      #     sky exec "$CLUSTER_NAME" -- 'set -e; cd sglang-jax/test/srt; python3 -m unittest test_bench_serving.TestBenchServing.test_offline_throughput_without_radix_cache'

      # - name: Benchmark offline throughput (Non-streaming, small batch size)
      #   timeout-minutes: 10
      #   run: |
      #     source ~/sky/bin/activate
      #     CLUSTER_NAME=$(bash scripts/get_cluster_name.sh tpu-v6e-1 ${{ github.ref }} performance)
      #     sky exec "$CLUSTER_NAME" -- 'set -e; cd sglang-jax/test/srt; python3 -m unittest test_bench_serving.TestBenchServing.test_offline_throughput_non_stream_small_batch_size'

      # - name: Benchmark offline throughput
      #   timeout-minutes: 10
      #   run: |
      #     source ~/sky/bin/activate
      #     CLUSTER_NAME=$(bash scripts/get_cluster_name.sh tpu-v6e-1 ${{ github.ref }} performance)
      #     sky exec "$CLUSTER_NAME" -- 'set -e; cd sglang-jax/test/srt; python3 -m unittest test_bench_serving.TestBenchServing.test_offline_throughput_default'


  # performance-test-4-tpu:
  #   if: github.event.pull_request.draft == false
  #   runs-on: self-hosted
  #   strategy:
  #     fail-fast: false
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  # accuracy-test-1-tpu:
  #   if: github.event.pull_request.draft == false
  #   runs-on: self-hosted
  #   strategy:
  #     fail-fast: false
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     - name: Setup environment
  #       uses: ./.github/actions/setup_environment
  #       with:
  #         accelerator: tpu-v6e-1
  #         test_type: accuracy
  #         skypilot_endpoint: ${{ secrets.SKYPILOT_ENDPOINT }}
  #         username: ${{ secrets.USERNAME }}
  #         git_token: ${{ secrets.GIT_TOKEN }}
  #     - name: Install dependencies
  #       run: |
  #         source ~/sky/bin/activate
  #         CLUSTER_NAME=$(bash scripts/get_cluster_name.sh tpu-v6e-1 ${{ github.ref }} accuracy)
  #         sky exec "$CLUSTER_NAME" -- 'set -e; if [ ! -d "human-eval" ] || [ -z "$(ls -A human-eval)" ]; then git clone https://github.com/merrymercy/human-eval.git; fi; cd human-eval; uv pip install -e .'

  #     - name: Evaluate accuracy
  #       timeout-minutes: 60
  #       run: |
  #         source ~/sky/bin/activate
  #         CLUSTER_NAME=$(bash scripts/get_cluster_name.sh tpu-v6e-1 ${{ github.ref }} accuracy)
  #         sky exec "$CLUSTER_NAME" -- 'set -e; cd sglang-jax/test/srt; python3 test_eval_accuracy_large.py'
